name: Android Build Test

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build-android:
        runs-on: ubuntu-latest
        timeout-minutes: 25

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "pnpm"

            - name: Set up pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 9.14.4

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # âš¡ï¸ è·³è¿‡ Expo é¢„ç¼–è¯‘ï¼ˆå¦‚æœ android æ–‡ä»¶å¤¹å·²ç»å­˜åœ¨ï¼‰
            - name: Prebuild Android project
              run: pnpm expo prebuild --platform android --non-interactive --no-install
              env:
                  EXPO_NO_DOCTOR: 1

            # ğŸ§  ç¼“å­˜ Gradle ä¾èµ–ï¼ˆæå¤§åŠ é€Ÿ Android æ„å»ºï¼‰
            - name: Cache Gradle
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # âš™ï¸ æ„å»º Android Debug APKï¼ˆæœ€å¿«ï¼‰
            - name: Build Android Debug APK
              run: |
                  cd android
                  ./gradlew assembleDebug --no-daemon --parallel --build-cache --configure-on-demand
              env:
                  CI: true

            - name: Notify on failure
              if: failure()
              run: echo "âŒ Android build failed. Please check the logs above."
